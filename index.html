<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Three Tails Tavern JukeBox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --card: #02081a;
      --border: #1f2937;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.2);
      --accent-text: #bbf7d0;
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.2);
      --text: #e5e7eb;
      --text-dim: #9ca3af;
      --radius-lg: 22px;
      --radius-md: 14px;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.55);
      --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font);
      color: var(--text);
      background: radial-gradient(circle at top left, #0b1220, #020617 60%);
      display: flex;
      justify-content: center;
      padding: 10px;
    }
    .app {
      width: 100%;
      max-width: 1200px;
      background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(6,8,20,0.98));
      border-radius: 26px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148,163,184,0.3);
      padding: 14px 14px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 4px 4px 2px;
    }
    .title-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .title {
      font-size: 1.4rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tagline {
      font-size: .9rem;
      color: var(--text-dim);
    }
    .status-area {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: .9rem;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.95);
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--danger);
    }
    .status-dot.ok {
      background: #22c55e;
    }
    .status-label {
      color: var(--text-dim);
      font-size: .85rem;
    }
    .status-value {
      font-weight: 600;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      padding: 10px 18px;
      font-size: .95rem;
      font-weight: 600;
      color: var(--text);
      background: rgba(15,23,42,0.95);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      min-width: 120px;
      min-height: 44px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      transition: background .12s ease, transform .06s ease, box-shadow .12s ease;
    }
    .btn:hover { background: rgba(31,41,55,0.95); transform: translateY(-1px); }
    .btn:active { transform: translateY(0); box-shadow: none; }
    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-color: #22c55e;
      color: #022c22;
      box-shadow: 0 8px 24px rgba(34,197,94,0.5);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #4ade80, #22c55e);
    }
    .btn-ghost {
      background: transparent;
      border-color: rgba(148,163,184,0.5);
    }
    .btn-sm {
      min-width: 80px;
      padding: 8px 12px;
      font-size: .85rem;
    }
    .btn-cancel {
        background: rgba(248, 113, 113, 0.15);
        color: #fca5a5;
        border-color: rgba(248, 113, 113, 0.4);
    }
    .btn-debug {
        background: rgba(59, 130, 246, 0.15);
        color: #93c5fd;
        border: 1px solid rgba(59, 130, 246, 0.4);
    }

    /* NOW PLAYING CARD */
    .now-playing {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 10px 14px;
      border-radius: 18px;
      border: 1px solid rgba(55,65,81,0.85);
      background: radial-gradient(circle at top left, rgba(34,197,94,0.12), rgba(6,10,25,0.98));
      box-shadow: 0 12px 30px rgba(0,0,0,0.55);
      position: relative;
      overflow: hidden;
    }
    /* Pending Switch Overlay */
    .pending-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(2, 6, 23, 0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 10;
      backdrop-filter: blur(4px);
    }
    
    .np-art {
      width: 78px;
      height: 78px;
      border-radius: 18px;
      background-size: cover;
      background-position: center;
      background-color: #020617;
      flex-shrink: 0;
    }
    .np-content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .np-title {
      font-size: 1rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .np-artist {
      font-size: .86rem;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .np-meta {
      font-size: .8rem;
      color: var(--text-dim);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .np-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .np-status-pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: .78rem;
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--text-dim);
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }
    @media (min-width: 900px) {
      .layout {
        flex-direction: row;
        gap: 10px;
        align-items: stretch;
      }
      .col {
        flex: 1;
      }
    }

    .panel {
      background: radial-gradient(circle at top left, rgba(30,64,175,0.18), rgba(6,10,25,0.98));
      border-radius: var(--radius-lg);
      border: 1px solid rgba(30,64,175,0.5);
      padding: 12px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .panel-title {
      font-size: 1.05rem;
      font-weight: 600;
    }
    .panel-subtitle {
      font-size: .85rem;
      color: var(--text-dim);
      margin-top: 2px;
    }

    .search-bar {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .input-row {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }
    .input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(6,8,20,0.98);
      padding: 11px 15px;
      color: var(--text);
      font-size: 1rem;
      outline: none;
      min-height: 44px;
    }
    .input::placeholder { color: #6b7280; }

    .tracks-list {
      border-radius: var(--radius-md);
      border: 1px solid rgba(31,41,55,0.95);
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), #020617);
      padding: 4px;
      max-height: 430px;
      overflow-y: auto;
      margin-top: 4px;
    }

    .track-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 8px;
      border-radius: 13px;
      cursor: pointer;
      transition: background .08s ease, transform .04s ease;
      min-height: 52px;
    }
    .track-row:hover {
      background: rgba(31,41,55,0.95);
      transform: translateY(-1px);
    }
    .track-main {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .track-title {
      font-size: .98rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .track-sub {
      font-size: .8rem;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .track-right {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
      justify-content: center;
    }
    .track-reorder {
      display: flex;
      gap: 4px;
    }

    .btn-icon {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      padding: 8px 14px;
      min-width: 70px;
      min-height: 40px;
      font-size: .86rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      transition: background .08s ease, transform .04s ease, box-shadow .08s ease;
    }
    .btn-add {
      background: var(--accent-soft);
      color: var(--accent-text);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.3);
    }
    .btn-add:hover { background: rgba(34,197,94,0.3); transform: translateY(-1px); }
    .btn-remove {
      background: var(--danger-soft);
      color: #fecaca;
      box-shadow: 0 0 0 1px rgba(248,113,113,0.3);
    }
    .btn-remove:hover { background: rgba(248,113,113,0.35); transform: translateY(-1px); }
    .btn-mini {
      min-width: 36px;
      min-height: 32px;
      padding: 4px 8px;
      font-size: .8rem;
      box-shadow: none;
      background: rgba(15,23,42,0.95);
      color: var(--text-dim);
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
    }
    .btn-mini:hover {
      background: rgba(31,41,55,0.95);
    }

    .msg {
      font-size: .82rem;
      color: var(--text-dim);
      margin-top: 4px;
      min-height: 18px;
    }
    .msg.error { color: var(--danger); }
    .msg.success { color: var(--accent-text); }
    
    .playlist-controls {
      display:flex; 
      gap:8px; 
      align-items:center;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-block">
      <div class="title">
        üéß Three Tails Tavern JukeBox
      </div>
      <div class="tagline">
        Guests add songs to the party playlist. You pick your Sonos group in the Spotify app.
      </div>
    </div>
    <div class="status-area">
      <div class="status-chip" id="authStatusChip">
        <span class="status-dot" id="authStatusDot"></span>
        <span class="status-label">Spotify</span>
        <span class="status-value" id="authStatusText">Not connected</span>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-ghost" id="logoutBtn" style="display:none;">Log out</button>
        <button class="btn btn-primary" id="loginBtn">Connect Spotify</button>
      </div>
    </div>
  </header>

  <section class="now-playing" id="nowPlayingCard">
    <div id="pendingOverlay" class="pending-overlay" style="display:none;">
      <div style="color: var(--accent-text); font-weight:600; font-size:0.95rem;">
        ‚åõ Switching to JukeBox in <span id="pendingTimer">0:00</span>...
      </div>
      <button class="btn btn-cancel btn-sm" id="cancelSwitchBtn">Cancel</button>
    </div>

    <div class="np-art" id="nowPlayingArt"></div>
    <div class="np-content">
      <div class="np-title" id="nowPlayingTitle">Not playing</div>
      <div class="np-artist" id="nowPlayingArtist">
        Start music from Spotify and select your Sonos group.
      </div>
      <div class="np-meta">
        <span id="nowPlayingDevice"></span>
        <span class="np-status-pill" id="nowPlayingStatus"></span>
      </div>
    </div>
  </section>

  <div class="layout">
    <div class="col">
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Search music</div>
            <div class="panel-subtitle">Type a song, artist, or album. Tap ‚ûï to add.</div>
          </div>
        </div>
        <div class="search-bar">
          <div class="input-row">
            <input id="searchInput" class="input" type="text" placeholder="Search Spotify‚Ä¶" />
            <button class="btn" id="searchBtn">Search</button>
          </div>
        </div>
        <div class="tracks-list" id="searchResults"></div>
        <div class="msg" id="searchMessage"></div>
      </section>
    </div>

    <div class="col">
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Party playlist</div>
            <div class="panel-subtitle">Shared queue</div>
          </div>
          <div class="playlist-controls">
            <button class="btn btn-debug btn-sm" id="debugSpeakersBtn">üïµÔ∏è List Speakers</button>
            <button class="btn btn-primary btn-sm" id="forcePlayBtn">‚ñ∂ Start JukeBox</button>
            <button class="btn btn-ghost btn-sm" id="refreshPlaylistBtn">Refresh</button>
          </div>
        </div>
        <div class="tracks-list" id="playlistView"></div>
        <div class="msg" id="playlistMessage"></div>
      </section>
    </div>
  </div>
</div>

<script>
  /**************************************************************
   * CONFIG
   **************************************************************/
  const SPOTIFY_CLIENT_ID = "b48fe08bcf6c448aabe8774fbfdcd943";
  const REDIRECT_URI = "https://rochesterftp-sonos.github.io/sonos103/"; 
  const PARTY_PLAYLIST_ID = "3oHuSCHOpiA2DOOI72uR2f"; 
  const PLAYLIST_URI = "spotify:playlist:3oHuSCHOpiA2DOOI72uR2f";

  // Auto-remove the last played track from the playlist when the song changes
  const AUTO_REMOVE_PLAYED = true;

  const SPOTIFY_SCOPES = [
    "playlist-read-private",
    "playlist-modify-private",
    "playlist-modify-public",
    "user-read-playback-state",
    "user-read-currently-playing",
    "user-modify-playback-state" 
  ];

  let lastSnapshotId = null;
  let nowPlaying = null;
  let nowPlayingIntervalId = null;
  let lastTrackUri = null;
  
  // For Smooth Switching
  let switchTimer = null;
  let switchInterval = null;

  /**************************************************************
   * AUTH + TOKEN HELPERS
   **************************************************************/
  const authStatusDot = document.getElementById("authStatusDot");
  const authStatusText = document.getElementById("authStatusText");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  function setAuthStatus(connected, text) {
    authStatusDot.classList.toggle("ok", connected);
    authStatusText.textContent = text;
    logoutBtn.style.display = connected ? "inline-flex" : "none";
    loginBtn.style.display = connected ? "none" : "inline-flex";
  }

  function generateRandomString(length) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
    let result = "";
    const array = new Uint8Array(length);
    window.crypto.getRandomValues(array);
    array.forEach((v) => (result += chars[v % chars.length]));
    return result;
  }

  async function sha256(plain) {
    const encoder = new TextEncoder();
    const data = encoder.encode(plain);
    return await window.crypto.subtle.digest("SHA-256", data);
  }

  function base64UrlEncode(arrayBuffer) {
    let bytes = new Uint8Array(arrayBuffer);
    let binary = "";
    bytes.forEach((b) => (binary += String.fromCharCode(b)));
    return btoa(binary)
      .replace(/\+/g, "-")
      .replace(/\//g, "_")
      .replace(/=+$/, "");
  }

  async function createCodeChallenge(verifier) {
    const hashed = await sha256(verifier);
    return base64UrlEncode(hashed);
  }

  function getStoredTokens() {
    const raw = localStorage.getItem("sj_spotify_tokens");
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }

  function storeTokens(tokens) {
    localStorage.setItem("sj_spotify_tokens", JSON.stringify(tokens));
  }

  function clearTokens() {
    localStorage.removeItem("sj_spotify_tokens");
  }

  // --- API HELPER WITH STANDARD URLS ---
  async function fetchWithAuth(url, options = {}) {
    let tokens = getStoredTokens();
    if (!tokens || !tokens.access_token) {
      throw new Error("Not authenticated with Spotify");
    }
    const headers = options.headers || {};
    if (options.body !== undefined && options.body !== null &&
        options.method && options.method !== "GET") {
      headers["Content-Type"] = headers["Content-Type"] || "application/json";
    }
    headers["Authorization"] = `Bearer ${tokens.access_token}`;
    options.headers = headers;

    let res = await fetch(url, options);
    if (res.status === 401 && tokens.refresh_token) {
      const ok = await refreshAccessToken(tokens.refresh_token);
      if (!ok) throw new Error("Spotify session expired. Please reconnect.");
      tokens = getStoredTokens();
      headers["Authorization"] = `Bearer ${tokens.access_token}`;
      options.headers = headers;
      res = await fetch(url, options);
    }
    if (!res.ok) {
      const body = await res.text();
      throw new Error(`Spotify error ${res.status}: ${body}`);
    }
    return res;
  }

  async function refreshAccessToken(refreshToken) {
    const params = new URLSearchParams();
    params.append("grant_type", "refresh_token");
    params.append("refresh_token", refreshToken);
    params.append("client_id", SPOTIFY_CLIENT_ID);

    const res = await fetch("https://accounts.spotify.com/api/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: params,
    });
    if (!res.ok) {
      clearTokens();
      return false;
    }
    const data = await res.json();
    const existing = getStoredTokens() || {};
    const merged = {
      ...existing,
      access_token: data.access_token,
      expires_in: data.expires_in,
      token_type: data.token_type,
    };
    if (data.refresh_token) {
      merged.refresh_token = data.refresh_token;
    }
    storeTokens(merged);
    return true;
  }

  function beginSpotifyLogin() {
    const state = generateRandomString(16);
    const codeVerifier = generateRandomString(64);
    localStorage.setItem("sj_spotify_state", state);
    localStorage.setItem("sj_spotify_verifier", codeVerifier);

    createCodeChallenge(codeVerifier).then((codeChallenge) => {
      const params = new URLSearchParams();
      params.append("client_id", SPOTIFY_CLIENT_ID);
      params.append("response_type", "code");
      params.append("redirect_uri", REDIRECT_URI);
      params.append("code_challenge_method", "S256");
      params.append("code_challenge", codeChallenge);
      params.append("state", state);
      params.append("scope", SPOTIFY_SCOPES.join(" "));

      const authUrl = `https://accounts.spotify.com/authorize?${params.toString()}`;
      window.location = authUrl;
    });
  }

  async function handleAuthCallback() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const state = params.get("state");
    const storedState = localStorage.getItem("sj_spotify_state");

    if (!code) return;

    window.history.replaceState({}, document.title, REDIRECT_URI);

    if (!state || state !== storedState) {
      alert("Spotify login failed. Please try again.");
      return;
    }
    const codeVerifier = localStorage.getItem("sj_spotify_verifier");
    if (!codeVerifier) {
      alert("Missing code verifier; reload and try again.");
      return;
    }

    const body = new URLSearchParams();
    body.append("grant_type", "authorization_code");
    body.append("code", code);
    body.append("redirect_uri", REDIRECT_URI);
    body.append("client_id", SPOTIFY_CLIENT_ID);
    body.append("code_verifier", codeVerifier);

    try {
      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body,
      });
      if (!res.ok) {
        const txt = await res.text();
        console.error("Token exchange failed:", txt);
        alert("Spotify login failed. Check redirect URI and try again.");
        return;
      }
      const data = await res.json();
      storeTokens(data);
      localStorage.removeItem("sj_spotify_state");
      localStorage.removeItem("sj_spotify_verifier");
      setAuthStatus(true, "Connected");
      await refreshPlaylistView();
      await refreshNowPlaying();
      startNowPlayingPolling();
    } catch (err) {
      console.error(err);
      alert("Error completing Spotify login.");
    }
  }

  /**************************************************************
   * DEVICE FINDER HELPER (THE FIX)
   **************************************************************/
  async function findBestSpeakerDevice() {
    const res = await fetchWithAuth("https://api.spotify.com/v1/me/player/devices");
    const data = await res.json();
    const devices = data.devices || [];

    if (devices.length === 0) return null;

    // 1. Filter specifically for SPEAKERS (Exclude Phones/Computers)
    // Spotify Types: Computer, Smartphone, Speaker, CastAudio, CastVideo, AVR, etc.
    const speakers = devices.filter(d => 
        d.type.toLowerCase() === 'speaker' || 
        d.type.toLowerCase() === 'castaudio' ||
        d.type.toLowerCase() === 'castvideo' ||
        d.type.toLowerCase() === 'avr'
    );

    if (speakers.length === 0) {
        // We found devices (likely your iPhone) but NO speakers.
        // Return null so we don't accidentally play on the phone.
        return null;
    }

    // 2. Look for "Basement" (Matches "Basement", "Basement + 1", etc.)
    let target = speakers.find(d => d.name.toLowerCase().includes("basement"));

    // 3. Look for "Family Room"
    if (!target) {
        target = speakers.find(d => d.name.toLowerCase().includes("family room"));
    }

    // 4. Look for "Sonos"
    if (!target) {
        target = speakers.find(d => d.name.toLowerCase().includes("sonos"));
    }

    // 5. Fallback: First Active Speaker
    if (!target) {
        target = speakers.find(d => d.is_active);
    }

    // 6. Last Resort: Any Speaker
    if (!target) {
        target = speakers[0];
    }

    return target;
  }

  /**************************************************************
   * SEARCH & ADD
   **************************************************************/
  const searchInput = document.getElementById("searchInput");
  const searchBtn = document.getElementById("searchBtn");
  const searchResults = document.getElementById("searchResults");
  const searchMessage = document.getElementById("searchMessage");

  async function performSearch() {
    const q = searchInput.value.trim();
    if (!q) {
      searchMessage.textContent = "Type something to search.";
      return;
    }
    searchMessage.textContent = "Searching‚Ä¶";
    searchResults.innerHTML = "";

    try {
      const url = `https://api.spotify.com/v1/search?type=track&q=${encodeURIComponent(q)}`;
      const res = await fetchWithAuth(url);
      const data = await res.json();
      const tracks = data.tracks?.items || [];
      if (!tracks.length) {
        searchMessage.textContent = "No results. Try a different search.";
        return;
      }
      searchMessage.textContent = `Tap ‚ûï to add a track.`;
      tracks.forEach((t) => {
        const row = document.createElement("div");
        row.className = "track-row";

        const main = document.createElement("div");
        main.className = "track-main";

        const title = document.createElement("div");
        title.className = "track-title";
        title.textContent = t.name;

        const sub = document.createElement("div");
        sub.className = "track-sub";
        const artistNames = t.artists.map((a) => a.name).join(", ");
        sub.textContent = `${artistNames} ‚Ä¢ ${t.album.name}`;

        main.appendChild(title);
        main.appendChild(sub);

        const right = document.createElement("div");
        right.className = "track-right";

        const addBtn = document.createElement("button");
        addBtn.className = "btn-icon btn-add";
        addBtn.innerHTML = "‚ûï Add";
        addBtn.onclick = (e) => {
          e.stopPropagation();
          addTrackToParty(t);
        };

        right.appendChild(addBtn);
        row.appendChild(main);
        row.appendChild(right);
        searchResults.appendChild(row);
      });
    } catch (err) {
      console.error(err);
      searchMessage.textContent = "Error talking to Spotify. Try reconnecting.";
    }
  }

  async function addTrackToParty(track) {
    if (!PARTY_PLAYLIST_ID) {
      alert("Playlist ID not set.");
      return;
    }

    searchMessage.textContent = `Adding "${track.name}"‚Ä¶`;

    try {
      // 1) Add to the party playlist
      await fetchWithAuth(
        `https://api.spotify.com/v1/playlists/${PARTY_PLAYLIST_ID}/tracks`,
        {
          method: "POST",
          body: JSON.stringify({ uris: [track.uri] }),
        }
      );

      // 2) Check if we need to switch (Drift Logic)
      const st = await fetchWithAuth("https://api.spotify.com/v1/me/player");
      
      if (st.status === 204) {
         // Nothing playing. Try to start Jukebox on a SPEAKER.
         const targetDevice = await findBestSpeakerDevice();
         if (targetDevice) {
             searchMessage.textContent = `Added. Starting on ${targetDevice.name}...`;
             await executeSwitch(targetDevice.id, track.uri);
         } else {
             searchMessage.textContent = "Added. (No speakers found to auto-start)";
         }
      } else {
         const state = await st.json();
         const contextUri = state?.context?.uri || "";
         const isOurPlaylist = (contextUri === PLAYLIST_URI);
         
         if (isOurPlaylist) {
            // Already playing correctly. Just queue.
            const queueUrl = `https://api.spotify.com/v1/me/player/queue?uri=${encodeURIComponent(track.uri)}`;
            await fetchWithAuth(queueUrl, { method: "POST" });
            searchMessage.textContent = `Added & Queued: ${track.name}`;
         } else {
            // DRIFTED -> Need to switch back.
            // BUT FIRST: Ensure we are switching to a SPEAKER, not the iPhone.
            let targetDeviceId = state.device.id;
            
            // If the current active device is a Smartphone, try to find a Speaker instead.
            if (state.device.type === 'Smartphone' || state.device.type === 'Computer') {
                const bestSpeaker = await findBestSpeakerDevice();
                if (bestSpeaker) {
                    targetDeviceId = bestSpeaker.id;
                    console.log("Redirecting playback from Phone to Speaker:", bestSpeaker.name);
                } else {
                    searchMessage.textContent = "Added. (Could not find Sonos to switch to)";
                    return; 
                }
            }
            
            // Calculate delay
            const progress = state.progress_ms || 0;
            const duration = state.item?.duration_ms || 0;
            const remainingMs = duration - progress;
            
            searchMessage.textContent = `Added. JukeBox will resume after this song.`;
            initiateSmoothSwitch(targetDeviceId, remainingMs, track.uri);
         }
      }

      await refreshPlaylistView();

    } catch (err) {
      console.error(err);
      searchMessage.textContent = "Added to playlist.";
    }
  }

  /**************************************************************
   * FORCE PLAY BUTTON (SMOOTH SWITCH LOGIC)
   **************************************************************/
  const forcePlayBtn = document.getElementById("forcePlayBtn");
  const pendingOverlay = document.getElementById("pendingOverlay");
  const pendingTimer = document.getElementById("pendingTimer");
  const cancelSwitchBtn = document.getElementById("cancelSwitchBtn");
  
  function cancelSmoothSwitch() {
    if (switchTimer) clearTimeout(switchTimer);
    if (switchInterval) clearInterval(switchInterval);
    switchTimer = null;
    switchInterval = null;
    pendingOverlay.style.display = "none";
    playlistMessage.textContent = "Switch cancelled.";
  }
  
  cancelSwitchBtn.addEventListener("click", cancelSmoothSwitch);

  function formatTime(ms) {
    const totalSec = Math.floor(ms / 1000);
    const m = Math.floor(totalSec / 60);
    const s = totalSec % 60;
    return `${m}:${s.toString().padStart(2, '0')}`;
  }

  async function initiateSmoothSwitch(deviceId, delayMs, specificTrackUri = null) {
    cancelSmoothSwitch(); 

    if (delayMs < 2000) {
       await executeSwitch(deviceId, specificTrackUri);
       return;
    }

    pendingOverlay.style.display = "flex";
    
    let timeLeft = delayMs;
    pendingTimer.textContent = formatTime(timeLeft);
    
    switchInterval = setInterval(() => {
      timeLeft -= 1000;
      if (timeLeft < 0) timeLeft = 0;
      pendingTimer.textContent = formatTime(timeLeft);
    }, 1000);

    switchTimer = setTimeout(async () => {
      await executeSwitch(deviceId, specificTrackUri);
      cancelSmoothSwitch(); 
    }, delayMs - 500); 
  }
  
  async function executeSwitch(deviceId, offsetUri) {
     try {
        const body = { context_uri: PLAYLIST_URI };
        if (offsetUri) {
           body.offset = { uri: offsetUri };
        }
        
        await fetchWithAuth(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
            method: "PUT",
            body: JSON.stringify(body)
        });
        playlistMessage.textContent = "Jukebox Started!";
        setTimeout(refreshNowPlaying, 1000);
     } catch(e) {
        console.error("Switch failed", e);
        playlistMessage.textContent = "Failed to switch.";
     }
  }

  forcePlayBtn.addEventListener("click", async () => {
    playlistMessage.textContent = "Locating Sonos...";
    
    try {
        // 1. Find the best SPEAKER (ignoring phones)
        const targetDevice = await findBestSpeakerDevice();

        if (!targetDevice) {
           alert("No Sonos/Speakers found.\n\nPlease open the Sonos app and play music for 1 second to wake them up, then try again.");
           playlistMessage.textContent = "No speakers found.";
           return;
        }

        const deviceId = targetDevice.id;
        playlistMessage.textContent = `Found: ${targetDevice.name}. Checking status...`;

        // 2. Get Player State to calculate delay
        const st = await fetchWithAuth("https://api.spotify.com/v1/me/player");
        
        if (st.status === 204) {
             // Nothing playing -> Start immediately
             await executeSwitch(deviceId, null);
             return;
        }

        const state = await st.json();
        const progress = state.progress_ms || 0;
        const duration = state.item?.duration_ms || 0;
        const remaining = duration - progress;
        
        initiateSmoothSwitch(deviceId, remaining, null);

    } catch (err) {
        console.error(err);
        playlistMessage.textContent = "Error checking status.";
    }
  });

  /**************************************************************
   * DEBUG BUTTON
   **************************************************************/
  document.getElementById("debugSpeakersBtn").addEventListener("click", async () => {
    try {
        const res = await fetchWithAuth("https://api.spotify.com/v1/me/player/devices");
        const data = await res.json();
        const devices = data.devices || [];
        
        if (devices.length === 0) {
            alert("Spotify found 0 devices.\n\nTip: Open the Sonos app or start playing music manually on your speaker to wake it up.");
        } else {
            const list = devices.map(d => 
                `‚Ä¢ ${d.name} [${d.type}] ${d.is_active ? '(Active)' : ''}`
            ).join("\n");
            alert("Spotify sees these devices:\n\n" + list);
        }
    } catch (err) {
        alert("Error fetching device list: " + err.message);
    }
  });


  /**************************************************************
   * PLAYLIST VIEW + REMOVE + REORDER
   **************************************************************/
  const playlistView = document.getElementById("playlistView");
  const playlistMessage = document.getElementById("playlistMessage");
  const refreshPlaylistBtn = document.getElementById("refreshPlaylistBtn");

  async function refreshPlaylistView() {
    playlistView.innerHTML = "";
    playlistMessage.textContent = "Loading playlist‚Ä¶";

    if (!PARTY_PLAYLIST_ID) {
      playlistMessage.textContent = "Playlist ID missing.";
      return;
    }

    try {
      const res = await fetchWithAuth(
        `https://api.spotify.com/v1/playlists/${PARTY_PLAYLIST_ID}`
      );
      const data = await res.json();

      lastSnapshotId = data.snapshot_id || null;
      const name = data.name || "Party playlist";
      const tracks = data.tracks?.items || [];

      playlistMessage.textContent = `${name} ‚Äì ${tracks.length} track(s)`;

      if (!tracks.length) {
        const empty = document.createElement("div");
        empty.className = "msg";
        empty.textContent = "Playlist is empty. Add something on the left.";
        playlistView.appendChild(empty);
        return;
      }

      tracks.forEach((item, index) => {
        const t = item.track;
        if (!t) return;

        const row = document.createElement("div");
        row.className = "track-row";

        const main = document.createElement("div");
        main.className = "track-main";

        const title = document.createElement("div");
        title.className = "track-title";
        title.textContent = `${index + 1}. ${t.name}`;

        const sub = document.createElement("div");
        sub.className = "track-sub";
        const artistNames = t.artists.map((a) => a.name).join(", ");
        sub.textContent = `${artistNames} ‚Ä¢ ${t.album.name}`;

        main.appendChild(title);
        main.appendChild(sub);

        const right = document.createElement("div");
        right.className = "track-right";

        const reorderRow = document.createElement("div");
        reorderRow.className = "track-reorder";

        const upBtn = document.createElement("button");
        upBtn.className = "btn-mini";
        upBtn.textContent = "‚Üë";
        upBtn.disabled = index === 0;
        upBtn.onclick = (e) => {
          e.stopPropagation();
          moveTrack(index, -1);
        };

        const downBtn = document.createElement("button");
        downBtn.className = "btn-mini";
        downBtn.textContent = "‚Üì";
        downBtn.disabled = index === tracks.length - 1;
        downBtn.onclick = (e) => {
          e.stopPropagation();
          moveTrack(index, +1);
        };

        reorderRow.appendChild(upBtn);
        reorderRow.appendChild(downBtn);

        const removeBtn = document.createElement("button");
        removeBtn.className = "btn-icon btn-remove";
        removeBtn.innerHTML = "üóë Remove";
        removeBtn.onclick = (e) => {
          e.stopPropagation();
          removeTrackFromParty(index, t.uri);
        };

        right.appendChild(reorderRow);
        right.appendChild(removeBtn);

        row.appendChild(main);
        row.appendChild(right);
        playlistView.appendChild(row);
      });
    } catch (err) {
      console.error(err);
      playlistMessage.textContent = "Error loading playlist.";
    }
  }

  async function moveTrack(position, delta) {
    if (lastSnapshotId === null) {
      alert("Playlist state not ready yet.");
      return;
    }
    const range_start = position;
    const insert_before = position + delta + (delta > 0 ? 1 : 0);

    try {
      const res = await fetchWithAuth(
        `https://api.spotify.com/v1/playlists/${PARTY_PLAYLIST_ID}/tracks`,
        {
          method: "PUT",
          body: JSON.stringify({
            range_start,
            range_length: 1,
            insert_before,
            snapshot_id: lastSnapshotId,
          }),
        }
      );
      const data = await res.json();
      lastSnapshotId = data.snapshot_id || lastSnapshotId;
      await refreshPlaylistView();
    } catch (err) {
      console.error("Reorder error:", err);
      playlistMessage.textContent = "Error reordering tracks.";
    }
  }

  async function removeTrackFromParty(position, uri, skipConfirm = false) {
    if (!PARTY_PLAYLIST_ID || lastSnapshotId === null) {
      return;
    }
    if (!skipConfirm) {
      const confirmRemove = confirm("Remove this track from the party playlist?");
      if (!confirmRemove) return;
    }

    try {
      const body = {
        tracks: [{ uri: uri, positions: [position] }],
        snapshot_id: lastSnapshotId
      };
      const res = await fetchWithAuth(
        `https://api.spotify.com/v1/playlists/${PARTY_PLAYLIST_ID}/tracks`,
        {
          method: "DELETE",
          body: JSON.stringify(body),
        }
      );
      const data = await res.json();
      lastSnapshotId = data.snapshot_id || lastSnapshotId;
      await refreshPlaylistView();
    } catch (err) {
      console.error("Error removing track:", err);
      playlistMessage.textContent = "Error removing track.";
    }
  }

  async function removeFirstOccurrenceOfTrack(uri) {
    try {
      const res = await fetchWithAuth(
        `https://api.spotify.com/v1/playlists/${PARTY_PLAYLIST_ID}`
      );
      const data = await res.json();
      lastSnapshotId = data.snapshot_id || lastSnapshotId;
      const items = data.tracks?.items || [];
      const idx = items.findIndex(it => it.track && it.track.uri === uri);
      if (idx === -1) return;
      await removeTrackFromParty(idx, uri, true);
    } catch (err) {
      console.error("Auto-remove error:", err);
    }
  }

  /**************************************************************
   * NOW PLAYING (READ-ONLY)
   **************************************************************/
  const nowPlayingArt = document.getElementById("nowPlayingArt");
  const nowPlayingTitle = document.getElementById("nowPlayingTitle");
  const nowPlayingArtist = document.getElementById("nowPlayingArtist");
  const nowPlayingDevice = document.getElementById("nowPlayingDevice");
  const nowPlayingStatus = document.getElementById("nowPlayingStatus");

  function renderEmptyNowPlaying() {
    nowPlaying = null;
    nowPlayingArt.style.backgroundImage = "none";
    nowPlayingTitle.textContent = "Not playing";
    nowPlayingArtist.textContent = "Start music from Spotify and select your Sonos group.";
    nowPlayingDevice.textContent = "";
    nowPlayingStatus.textContent = "";
  }

  function renderNowPlaying(data) {
    nowPlaying = data;

    const item = data.item;
    if (!item) {
      renderEmptyNowPlaying();
      return;
    }

    const img = (item.album.images && item.album.images[0]) || null;
    if (img) {
      nowPlayingArt.style.backgroundImage = `url("${img.url}")`;
    } else {
      nowPlayingArt.style.backgroundImage = "none";
    }

    const artistNames = item.artists.map(a => a.name).join(", ");

    nowPlayingTitle.textContent = item.name || "Unknown track";
    nowPlayingArtist.textContent = artistNames || "";
    nowPlayingDevice.textContent = data.device && data.device.name
      ? `Device: ${data.device.name}`
      : "";
    nowPlayingStatus.textContent = data.is_playing ? "Playing" : "Paused";
  }

  async function refreshNowPlaying() {
    try {
      const res = await fetchWithAuth(
        "https://api.spotify.com/v1/me/player"
      );
      if (res.status === 204) {
        renderEmptyNowPlaying();
        return;
      }
      const data = await res.json();
      if (!data || !data.item) {
        renderEmptyNowPlaying();
        return;
      }

      const currentUri = data.item.uri;
      if (AUTO_REMOVE_PLAYED && lastTrackUri && lastTrackUri !== currentUri) {
        removeFirstOccurrenceOfTrack(lastTrackUri);
      }
      lastTrackUri = currentUri;

      renderNowPlaying(data);
    } catch (err) {
      console.error("Now playing error:", err);
      renderEmptyNowPlaying();
    }
  }

  function startNowPlayingPolling() {
    stopNowPlayingPolling();
    nowPlayingIntervalId = setInterval(() => {
      refreshNowPlaying().catch(() => {});
    }, 15000); // every 15s
  }

  function stopNowPlayingPolling() {
    if (nowPlayingIntervalId) {
      clearInterval(nowPlayingIntervalId);
      nowPlayingIntervalId = null;
    }
  }

  /**************************************************************
   * EVENTS & INIT
   **************************************************************/
  loginBtn.addEventListener("click", beginSpotifyLogin);
  logoutBtn.addEventListener("click", () => {
    clearTokens();
    setAuthStatus(false, "Not connected");
    searchResults.innerHTML = "";
    playlistView.innerHTML = "";
    searchMessage.textContent = "";
    playlistMessage.textContent = "";
    renderEmptyNowPlaying();
    stopNowPlayingPolling();
  });

  searchBtn.addEventListener("click", performSearch);
  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") performSearch();
  });
  refreshPlaylistBtn.addEventListener("click", refreshPlaylistView);

  (async function init() {
    renderEmptyNowPlaying();
    const tokens = getStoredTokens();
    if (tokens && tokens.access_token) {
      setAuthStatus(true, "Connected");
      try {
        await refreshPlaylistView();
        await refreshNowPlaying();
        startNowPlayingPolling();
      } catch {}
    } else {
      setAuthStatus(false, "Not connected");
    }
    await handleAuthCallback();
  })();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Three Tails Tavern JukeBox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --card: #02081a;
      --border: #1f2937;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.2);
      --accent-text: #bbf7d0;
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.2);
      --text: #e5e7eb;
      --text-dim: #9ca3af;
      --radius-lg: 22px;
      --radius-md: 14px;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.55);
      --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font);
      color: var(--text);
      background: radial-gradient(circle at top left, #0b1220, #020617 60%);
      display: flex;
      justify-content: center;
      padding: 10px;
    }
    .app {
      width: 100%;
      max-width: 1200px;
      background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(6,8,20,0.98));
      border-radius: 26px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148,163,184,0.3);
      padding: 14px 14px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 4px 4px 2px;
    }
    .title-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .title {
      font-size: 1.4rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tagline {
      font-size: .9rem;
      color: var(--text-dim);
    }
    .status-area {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: .9rem;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.95);
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--danger);
    }
    .status-dot.ok {
      background: #22c55e;
    }
    .status-label {
      color: var(--text-dim);
      font-size: .85rem;
    }
    .status-value {
      font-weight: 600;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      padding: 10px 18px;
      font-size: .95rem;
      font-weight: 600;
      color: var(--text);
      background: rgba(15,23,42,0.95);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      min-width: 120px;
      min-height: 44px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      transition: background .12s ease, transform .06s ease, box-shadow .12s ease;
    }
    .btn:hover { background: rgba(31,41,55,0.95); transform: translateY(-1px); }
    .btn:active { transform: translateY(0); box-shadow: none; }
    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-color: #22c55e;
      color: #022c22;
      box-shadow: 0 8px 24px rgba(34,197,94,0.5);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #4ade80, #22c55e);
    }
    .btn-ghost {
      background: transparent;
      border-color: rgba(148,163,184,0.5);
    }
    .btn-sm {
      min-width: 80px;
      padding: 8px 12px;
      font-size: .85rem;
    }
    .btn-cancel {
        background: rgba(248, 113, 113, 0.15);
        color: #fca5a5;
        border-color: rgba(248, 113, 113, 0.4);
    }

    /* NOW PLAYING CARD */
    .now-playing {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 10px 14px;
      border-radius: 18px;
      border: 1px solid rgba(55,65,81,0.85);
      background: radial-gradient(circle at top left, rgba(34,197,94,0.12), rgba(6,10,25,0.98));
      box-shadow: 0 12px 30px rgba(0,0,0,0.55);
      position: relative;
      overflow: hidden;
    }
    /* Pending Switch Overlay */
    .pending-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(2, 6, 23, 0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 10;
      backdrop-filter: blur(4px);
    }
    
    .np-art {
      width: 78px;
      height: 78px;
      border-radius: 18px;
      background-size: cover;
      background-position: center;
      background-color: #020617;
      flex-shrink: 0;
    }
    .np-content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .np-title {
      font-size: 1rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .np-artist {
      font-size: .86rem;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .np-meta {
      font-size: .8rem;
      color: var(--text-dim);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .np-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .np-status-pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: .78rem;
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--text-dim);
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }
    @media (min-width: 900px) {
      .layout {
        flex-direction: row;
        gap: 10px;
        align-items: stretch;
      }
      .col {
        flex: 1;
      }
    }

    .panel {
      background: radial-gradient(circle at top left, rgba(30,64,175,0.18), rgba(6,10,25,0.98));
      border-radius: var(--radius-lg);
      border: 1px solid rgba(30,64,175,0.5);
      padding: 12px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .panel-title {
      font-size: 1.05rem;
      font-weight: 600;
    }
    .panel-subtitle {
      font-size: .85rem;
      color: var(--text-dim);
      margin-top: 2px;
    }

    .search-bar {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .input-row {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }
    .input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(6,8,20,0.98);
      padding: 11px 15px;
      color: var(--text);
      font-size: 1rem;
      outline: none;
      min-height: 44px;
    }
    .input::placeholder { color: #6b7280; }

    .tracks-list {
      border-radius: var(--radius-md);
      border: 1px solid rgba(31,41,55,0.95);
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), #020617);
      padding: 4px;
      max-height: 430px;
      overflow-y: auto;
      margin-top: 4px;
    }

    .track-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 8px;
      border-radius: 13px;
      cursor: pointer;
      transition: background .08s ease, transform .04s ease;
      min-height: 52px;
    }
    .track-row:hover {
      background: rgba(31,41,55,0.95);
      transform: translateY(-1px);
    }
    .track-main {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .track-title {
      font-size: .98rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .track-sub {
      font-size: .8rem;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .track-right {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
      justify-content: center;
    }
    .track-reorder {
      display: flex;
      gap: 4px;
    }

    .btn-icon {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      padding: 8px 14px;
      min-width: 70px;
      min-height: 40px;
      font-size: .86rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      transition: background .08s ease, transform .04s ease, box-shadow .08s ease;
    }
    .btn-add {
      background: var(--accent-soft);
      color: var(--accent-text);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.3);
    }
    .btn-add:hover { background: rgba(34,197,94,0.3); transform: translateY(-1px); }
    .btn-remove {
      background: var(--danger-soft);
      color: #fecaca;
      box-shadow: 0 0 0 1px rgba(248,113,113,0.3);
    }
    .btn-remove:hover { background: rgba(248,113,113,0.35); transform: translateY(-1px); }
    .btn-mini {
      min-width: 36px;
      min-height: 32px;
      padding: 4px 8px;
      font-size: .8rem;
      box-shadow: none;
      background: rgba(15,23,42,0.95);
      color: var(--text-dim);
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
    }
    .btn-mini:hover {
      background: rgba(31,41,55,0.95);
    }

    .msg {
      font-size: .82rem;
      color: var(--text-dim);
      margin-top: 4px;
      min-height: 18px;
    }
    .msg.error { color: var(--danger); }
    .msg.success { color: var(--accent-text); }
    
    .playlist-controls {
      display:flex; 
      gap:8px; 
      align-items:center;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-block">
      <div class="title">
        ðŸŽ§ Three Tails Tavern JukeBox
      </div>
      <div class="tagline">
        Guests add songs to the party playlist. You pick your Sonos group in the Spotify app.
      </div>
    </div>
    <div class="status-area">
      <div class="status-chip" id="authStatusChip">
        <span class="status-dot" id="authStatusDot"></span>
        <span class="status-label">Spotify</span>
        <span class="status-value" id="authStatusText">Not connected</span>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-ghost" id="logoutBtn" style="display:none;">Log out</button>
        <button class="btn btn-primary" id="loginBtn">Connect Spotify</button>
      </div>
    </div>
  </header>

  <section class="now-playing" id="nowPlayingCard">
    <div id="pendingOverlay" class="pending-overlay" style="display:none;">
      <div style="color: var(--accent-text); font-weight:600; font-size:0.95rem;">
        âŒ› Switching to JukeBox in <span id="pendingTimer">0:00</span>...
      </div>
      <button class="btn btn-cancel btn-sm" id="cancelSwitchBtn">Cancel</button>
    </div>

    <div class="np-art" id="nowPlayingArt"></div>
    <div class="np-content">
      <div class="np-title" id="nowPlayingTitle">Not playing</div>
      <div class="np-artist" id="nowPlayingArtist">
        Start music from Spotify and select your Sonos group.
      </div>
      <div class="np-meta">
        <span id="nowPlayingDevice"></span>
        <span class="np-status-pill" id="nowPlayingStatus"></span>
      </div>
    </div>
  </section>

  <div class="layout">
    <div class="col">
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Search music</div>
            <div class="panel-subtitle">Type a song, artist, or album. Tap âž• to add.</div>
          </div>
        </div>
        <div class="search-bar">
          <div class="input-row">
            <input id="searchInput" class="input" type="text" placeholder="Search Spotifyâ€¦" />
            <button class="btn" id="searchBtn">Search</button>
          </div>
        </div>
        <div class="tracks-list" id="searchResults"></div>
        <div class="msg" id="searchMessage"></div>
      </section>
    </div>

    <div class="col">
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Party playlist</div>
            <div class="panel-subtitle">Shared queue</div>
          </div>
          <div class="playlist-controls">
            <button class="btn btn-primary btn-sm" id="forcePlayBtn">â–¶ Start JukeBox</button>
            <button class="btn btn-ghost btn-sm" id="refreshPlaylistBtn">Refresh</button>
          </div>
        </div>
        <div class="tracks-list" id="playlistView"></div>
        <div class="msg" id="playlistMessage"></div>
      </section>
    </div>
  </div>
</div>

<script>
  /**************************************************************
   * CONFIG
   **************************************************************/
  const SPOTIFY_CLIENT_ID = "b48fe08bcf6c448aabe8774fbfdcd943";
  const REDIRECT_URI = "https://rochesterftp-sonos.github.io/sonos103/"; 
  const PARTY_PLAYLIST_ID = "3oHuSCHOpiA2DOOI72uR2f"; 
  const PLAYLIST_URI = "spotify:playlist:3oHuSCHOpiA2DOOI72uR2f";

  // Auto-remove the last played track from the playlist when the song changes
  const AUTO_REMOVE_PLAYED = true;

  const SPOTIFY_SCOPES = [
    "playlist-read-private",
    "playlist-modify-private",
    "playlist-modify-public",
    "user-read-playback-state",
    "user-read-currently-playing",
    "user-modify-playback-state" 
  ];

  let lastSnapshotId = null;
  let nowPlaying = null;
  let nowPlayingIntervalId = null;
  let lastTrackUri = null;
  
  // For Smooth Switching
  let switchTimer = null;
  let switchInterval = null;

  /**************************************************************
   * AUTH + TOKEN HELPERS
   **************************************************************/
  const authStatusDot = document.getElementById("authStatusDot");
  const authStatusText = document.getElementById("authStatusText");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  function setAuthStatus(connected, text) {
    authStatusDot.classList.toggle("ok", connected);
    authStatusText.textContent = text;
    logoutBtn.style.display = connected ? "inline-flex" : "none";
    loginBtn.style.display = connected ? "none" : "inline-flex";
  }

  function generateRandomString(length) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
    let result = "";
    const array = new Uint8Array(length);
    window.crypto.getRandomValues(array);
    array.forEach((v) => (result += chars[v % chars.length]));
    return result;
  }

  async function sha256(plain) {
    const encoder = new TextEncoder();
    const data = encoder.encode(plain);
    return await window.crypto.subtle.digest("SHA-256", data);
  }

  function base64UrlEncode(arrayBuffer) {
    let bytes = new Uint8Array(arrayBuffer);
    let binary = "";
    bytes.forEach((b) => (binary += String.fromCharCode(b)));
    return btoa(binary)
      .replace(/\+/g, "-")
      .replace(/\//g, "_")
      .replace(/=+$/, "");
  }

  async function createCodeChallenge(verifier) {
    const hashed = await sha256(verifier);
    return base64UrlEncode(hashed);
  }

  function getStoredTokens() {
    const raw = localStorage.getItem("sj_spotify_tokens");
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }

  function storeTokens(tokens) {
    localStorage.setItem("sj_spotify_tokens", JSON.stringify(tokens));
  }

  function clearTokens() {
    localStorage.removeItem("sj_spotify_tokens");
  }

  // --- API HELPER WITH STANDARD URLS ---
  async function fetchWithAuth(url, options = {}) {
    let tokens = getStoredTokens();
    if (!tokens || !tokens.access_token) {
      throw new Error("Not authenticated with Spotify");
    }
    const headers = options.headers || {};
    if (options.body !== undefined && options.body !== null &&
        options.method && options.method !== "GET") {
      headers["Content-Type"] = headers["Content-Type"] || "application/json";
    }
    headers["Authorization"] = `Bearer ${tokens.access_token}`;
    options.headers = headers;

    let res = await fetch(url, options);
    if (res.status === 401 && tokens.refresh_token) {
      const ok = await refreshAccessToken(tokens.refresh_token);
      if (!ok) throw new Error("Spotify session expired. Please reconnect.");
      tokens = getStoredTokens();
      headers["Authorization"] = `Bearer ${tokens.access_token}`;
      options.headers = headers;
      res = await fetch(url, options);
    }
    if (!res.ok) {
      const body = await res.text();
      throw new Error(`Spotify error ${res.status}: ${body}`);
    }
    return res;
  }

  async function refreshAccessToken(refreshToken) {
    const params = new URLSearchParams();
    params.append("grant_type", "refresh_token");
    params.append("refresh_token", refreshToken);
    params.append("client_id", SPOTIFY_CLIENT_ID);

    const res = await fetch("https://accounts.spotify.com/api/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: params,
    });
    if (!res.ok) {
      clearTokens();
      return false;
    }
    const data = await res.json();
    const existing = getStoredTokens() || {};
    const merged = {
      ...existing,
      access_token: data.access_token,
      expires_in: data.expires_in,
      token_type: data.token_type,
    };
    if (data.refresh_token) {
      merged.refresh_token = data.refresh_token;
    }
    storeTokens(merged);
    return true;
  }

  function beginSpotifyLogin() {
    const state = generateRandomString(16);
    const codeVerifier = generateRandomString(64);
    localStorage.setItem("sj_spotify_state", state);
    localStorage.setItem("sj_spotify_verifier", codeVerifier);

    createCodeChallenge(codeVerifier).then((codeChallenge) => {
      const params = new URLSearchParams();
      params.append("client_id", SPOTIFY_CLIENT_ID);
      params.append("response_type", "code");
      params.append("redirect_uri", REDIRECT_URI);
      params.append("code_challenge_method", "S256");
      params.append("code_challenge", codeChallenge);
      params.append("state", state);
      params.append("scope", SPOTIFY_SCOPES.join(" "));

      const authUrl = `https://accounts.spotify.com/authorize?${params.toString()}`;
      window.location = authUrl;
    });
  }

  async function handleAuthCallback() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const state = params.get("state");
    const storedState = localStorage.getItem("sj_spotify_state");

    if (!code) return;

    window.history.replaceState({}, document.title, REDIRECT_URI);

    if (!state || state !== storedState) {
      alert("Spotify login failed. Please try again.");
      return;
    }
    const codeVerifier = localStorage.getItem("sj_spotify_verifier");
    if (!codeVerifier) {
      alert("Missing code verifier; reload and try again.");
      return;
    }

    const body = new URLSearchParams();
    body.append("grant_type", "authorization_code");
    body.append("code", code);
    body.append("redirect_uri", REDIRECT_URI);
    body.append("client_id", SPOTIFY_
